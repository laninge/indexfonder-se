---
// Ränta på ränta-kalkulator - Lysa-inspired design with Opti colors
---

<section class="calculator-section" id="kalkylator">
  <div class="calculator-container">
    <div class="calculator-header">
      <h2>Ränta på ränta-kalkylator</h2>
      <p>Se hur ditt sparande kan växa över tid med ränta på ränta-effekten</p>
    </div>

    <div class="calculator-layout">
      <div class="calculator-inputs">
        <div class="calculator-field">
          <div class="calculator-field__header">
            <label for="startAmount">Startbelopp</label>
            <div class="calculator-field__value">
              <span id="startAmountDisplay">10 000</span> kr
            </div>
          </div>
          <input
            type="range"
            id="startAmount"
            min="0"
            max="500000"
            step="5000"
            value="10000"
            class="calculator-slider"
          />
          <div class="calculator-field__range">
            <span>0 kr</span>
            <span>500 000 kr</span>
          </div>
        </div>

        <div class="calculator-field">
          <div class="calculator-field__header">
            <label for="monthly">Månadssparande</label>
            <div class="calculator-field__value">
              <span id="monthlyDisplay">2 000</span> kr
            </div>
          </div>
          <input
            type="range"
            id="monthly"
            min="0"
            max="20000"
            step="500"
            value="2000"
            class="calculator-slider"
          />
          <div class="calculator-field__range">
            <span>0 kr</span>
            <span>20 000 kr</span>
          </div>
        </div>

        <div class="calculator-field">
          <div class="calculator-field__header">
            <label for="years">Spartid</label>
            <div class="calculator-field__value">
              <span id="yearsDisplay">20</span> år
            </div>
          </div>
          <input
            type="range"
            id="years"
            min="1"
            max="40"
            step="1"
            value="20"
            class="calculator-slider"
          />
          <div class="calculator-field__range">
            <span>1 år</span>
            <span>40 år</span>
          </div>
        </div>

        <div class="calculator-field">
          <div class="calculator-field__header">
            <label for="return">Årlig avkastning</label>
            <div class="calculator-field__value">
              <span id="returnDisplay">7</span> %
            </div>
          </div>
          <input
            type="range"
            id="return"
            min="0"
            max="15"
            step="0.5"
            value="7"
            class="calculator-slider"
          />
          <div class="calculator-field__range">
            <span>0 %</span>
            <span>15 %</span>
          </div>
          <p class="calculator-field__hint">7% är historiskt snitt för global aktiemarknad</p>
        </div>
      </div>

      <div class="calculator-results">
        <div class="calculator-total">
          <span class="calculator-total__label">Totalt efter <span id="totalYears">20</span> år</span>
          <span class="calculator-total__value" id="totalValue">1 050 509</span>
          <span class="calculator-total__currency">kr</span>
        </div>

        <div class="calculator-chart">
          <canvas id="savingsChart"></canvas>
        </div>

        <div class="calculator-breakdown">
          <div class="calculator-breakdown__item calculator-breakdown__item--return">
            <span class="calculator-breakdown__color"></span>
            <span class="calculator-breakdown__label">Avkastning</span>
            <span class="calculator-breakdown__value" id="totalReturn">569 509 kr</span>
          </div>
          <div class="calculator-breakdown__item calculator-breakdown__item--monthly">
            <span class="calculator-breakdown__color"></span>
            <span class="calculator-breakdown__label">Månadssparande</span>
            <span class="calculator-breakdown__value" id="totalMonthly">480 000 kr</span>
          </div>
          <div class="calculator-breakdown__item calculator-breakdown__item--start">
            <span class="calculator-breakdown__color"></span>
            <span class="calculator-breakdown__label">Startbelopp</span>
            <span class="calculator-breakdown__value" id="totalStart">10 000 kr</span>
          </div>
        </div>

        <p class="calculator-disclaimer">
          Beräkningen är en förenklad uppskattning. Historisk avkastning är ingen garanti för framtida resultat.
        </p>
      </div>
    </div>
  </div>
</section>

<style>
  .calculator-section {
    background: linear-gradient(180deg, var(--white) 0%, var(--gray-50) 100%);
    padding: 4rem 0;
  }

  .calculator-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 var(--container-padding);
  }

  .calculator-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .calculator-header h2 {
    font-size: var(--font-size-3xl);
    margin-bottom: 0.5rem;
  }

  .calculator-header p {
    color: var(--gray-500);
    font-size: var(--font-size-lg);
    margin-bottom: 0;
  }

  .calculator-layout {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 3rem;
    align-items: start;
  }

  /* Inputs */
  .calculator-inputs {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .calculator-field {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
  }

  .calculator-field__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .calculator-field__header label {
    font-weight: 600;
    color: var(--navy);
    font-size: var(--font-size-base);
  }

  .calculator-field__value {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--opti-mint);
  }

  .calculator-slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--gray-200);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
  }

  .calculator-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--opti-mint);
    cursor: pointer;
    border: 4px solid var(--white);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: transform var(--transition-fast);
  }

  .calculator-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .calculator-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--opti-mint);
    cursor: pointer;
    border: 4px solid var(--white);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .calculator-field__range {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: var(--font-size-xs);
    color: var(--gray-400);
  }

  .calculator-field__hint {
    margin-top: 0.75rem;
    margin-bottom: 0;
    font-size: var(--font-size-sm);
    color: var(--gray-500);
  }

  /* Results */
  .calculator-results {
    background: var(--navy);
    border-radius: var(--radius-xl);
    padding: 2rem;
    color: var(--white);
  }

  .calculator-total {
    text-align: center;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 1.5rem;
  }

  .calculator-total__label {
    display: block;
    font-size: var(--font-size-base);
    color: var(--gray-400);
    margin-bottom: 0.5rem;
  }

  .calculator-total__value {
    font-size: 3.5rem;
    font-weight: 700;
    color: var(--opti-mint);
    line-height: 1;
  }

  .calculator-total__currency {
    font-size: var(--font-size-2xl);
    font-weight: 400;
    color: var(--gray-400);
    margin-left: 0.25rem;
  }

  .calculator-chart {
    height: 200px;
    margin-bottom: 1.5rem;
  }

  .calculator-chart canvas {
    width: 100% !important;
    height: 100% !important;
  }

  .calculator-breakdown {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .calculator-breakdown__item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .calculator-breakdown__color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .calculator-breakdown__item--return .calculator-breakdown__color {
    background: var(--opti-mint);
  }

  .calculator-breakdown__item--monthly .calculator-breakdown__color {
    background: #60a5fa;
  }

  .calculator-breakdown__item--start .calculator-breakdown__color {
    background: #a78bfa;
  }

  .calculator-breakdown__label {
    flex: 1;
    color: var(--gray-400);
    font-size: var(--font-size-sm);
  }

  .calculator-breakdown__value {
    font-weight: 600;
    font-size: var(--font-size-base);
  }

  .calculator-disclaimer {
    margin-top: 1.5rem;
    margin-bottom: 0;
    font-size: var(--font-size-xs);
    color: var(--gray-500);
    text-align: center;
  }

  @media (max-width: 900px) {
    .calculator-layout {
      grid-template-columns: 1fr;
    }

    .calculator-results {
      order: -1;
    }

    .calculator-total__value {
      font-size: 2.5rem;
    }
  }

  @media (max-width: 480px) {
    .calculator-field {
      padding: 1rem;
    }

    .calculator-results {
      padding: 1.5rem;
    }

    .calculator-total__value {
      font-size: 2rem;
    }

    .calculator-chart {
      height: 150px;
    }
  }
</style>

<script>
  function formatNumber(value: number): string {
    return new Intl.NumberFormat('sv-SE').format(Math.round(value));
  }

  function formatCurrency(value: number): string {
    return formatNumber(value) + ' kr';
  }

  function updateSliderBackground(slider: HTMLInputElement): void {
    const min = parseFloat(slider.min);
    const max = parseFloat(slider.max);
    const value = parseFloat(slider.value);
    const percentage = ((value - min) / (max - min)) * 100;
    slider.style.background = `linear-gradient(to right, #3ECDA3 0%, #3ECDA3 ${percentage}%, #e2e8f0 ${percentage}%, #e2e8f0 100%)`;
  }

  function getYearlyData(startAmount: number, monthly: number, years: number, annualReturn: number): {
    startArr: number[],
    monthlyArr: number[],
    returnArr: number[],
    total: number[]
  } {
    const monthlyReturn = annualReturn / 100 / 12;
    const startArr: number[] = [];
    const monthlyArr: number[] = [];
    const returnArr: number[] = [];
    const total: number[] = [];

    for (let year = 1; year <= years; year++) {
      const months = year * 12;

      // Start amount with compound interest
      const startWithInterest = startAmount * Math.pow(1 + annualReturn / 100, year);

      // Monthly contributions with compound interest
      let monthlyWithInterest: number;
      if (monthlyReturn === 0) {
        monthlyWithInterest = monthly * months;
      } else {
        monthlyWithInterest = monthly * ((Math.pow(1 + monthlyReturn, months) - 1) / monthlyReturn);
      }

      const totalValue = startWithInterest + monthlyWithInterest;
      const totalInvested = startAmount + (monthly * months);
      const totalReturnValue = totalValue - totalInvested;

      startArr.push(startAmount);
      monthlyArr.push(monthly * months);
      returnArr.push(totalReturnValue);
      total.push(totalValue);
    }

    return { startArr, monthlyArr, returnArr, total };
  }

  function drawChart(data: { startArr: number[], monthlyArr: number[], returnArr: number[], total: number[] }): void {
    const canvas = document.getElementById('savingsChart') as HTMLCanvasElement;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const width = rect.width;
    const height = rect.height;
    const padding = { top: 10, right: 10, bottom: 25, left: 10 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    ctx.clearRect(0, 0, width, height);

    const years = data.total.length;
    const maxValue = Math.max(...data.total);

    const getX = (index: number) => padding.left + ((index + 1) / years) * chartWidth;
    const getY = (value: number) => padding.top + chartHeight - (value / maxValue) * chartHeight;

    // Draw stacked areas
    // Return area (top - mint)
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    for (let i = 0; i < years; i++) {
      ctx.lineTo(getX(i), getY(data.total[i]));
    }
    ctx.lineTo(getX(years - 1), padding.top + chartHeight);
    ctx.closePath();
    ctx.fillStyle = 'rgba(62, 205, 163, 0.6)';
    ctx.fill();

    // Monthly area (middle - blue)
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    for (let i = 0; i < years; i++) {
      ctx.lineTo(getX(i), getY(data.startArr[i] + data.monthlyArr[i]));
    }
    ctx.lineTo(getX(years - 1), padding.top + chartHeight);
    ctx.closePath();
    ctx.fillStyle = 'rgba(96, 165, 250, 0.6)';
    ctx.fill();

    // Start area (bottom - purple)
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    for (let i = 0; i < years; i++) {
      ctx.lineTo(getX(i), getY(data.startArr[i]));
    }
    ctx.lineTo(getX(years - 1), padding.top + chartHeight);
    ctx.closePath();
    ctx.fillStyle = 'rgba(167, 139, 250, 0.6)';
    ctx.fill();

    // X-axis labels
    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.font = '11px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Idag', padding.left, height - 5);
    ctx.fillText(`${years} år`, width - padding.right, height - 5);
  }

  function calculateSavings(): void {
    const startAmount = parseFloat((document.getElementById('startAmount') as HTMLInputElement).value) || 0;
    const monthly = parseFloat((document.getElementById('monthly') as HTMLInputElement).value) || 0;
    const years = parseFloat((document.getElementById('years') as HTMLInputElement).value) || 1;
    const annualReturn = parseFloat((document.getElementById('return') as HTMLInputElement).value) || 0;

    // Update display values
    (document.getElementById('startAmountDisplay') as HTMLElement).textContent = formatNumber(startAmount);
    (document.getElementById('monthlyDisplay') as HTMLElement).textContent = formatNumber(monthly);
    (document.getElementById('yearsDisplay') as HTMLElement).textContent = years.toString();
    (document.getElementById('returnDisplay') as HTMLElement).textContent = annualReturn.toString();
    (document.getElementById('totalYears') as HTMLElement).textContent = years.toString();

    // Calculate
    const monthlyReturn = annualReturn / 100 / 12;
    const months = years * 12;

    // Start amount with compound interest
    const startWithInterest = startAmount * Math.pow(1 + annualReturn / 100, years);

    // Monthly contributions with compound interest
    let monthlyWithInterest: number;
    if (monthlyReturn === 0) {
      monthlyWithInterest = monthly * months;
    } else {
      monthlyWithInterest = monthly * ((Math.pow(1 + monthlyReturn, months) - 1) / monthlyReturn);
    }

    const totalValue = startWithInterest + monthlyWithInterest;
    const totalInvested = startAmount + (monthly * months);
    const totalReturnValue = totalValue - totalInvested;

    // Update results
    (document.getElementById('totalValue') as HTMLElement).textContent = formatNumber(totalValue);
    (document.getElementById('totalReturn') as HTMLElement).textContent = formatCurrency(totalReturnValue);
    (document.getElementById('totalMonthly') as HTMLElement).textContent = formatCurrency(monthly * months);
    (document.getElementById('totalStart') as HTMLElement).textContent = formatCurrency(startAmount);

    // Update chart
    const data = getYearlyData(startAmount, monthly, Math.floor(years), annualReturn);
    drawChart(data);

    // Update slider backgrounds
    document.querySelectorAll('.calculator-slider').forEach(slider => {
      updateSliderBackground(slider as HTMLInputElement);
    });
  }

  // Add event listeners
  ['startAmount', 'monthly', 'years', 'return'].forEach(id => {
    const el = document.getElementById(id);
    el?.addEventListener('input', calculateSavings);
  });

  // Initial calculation
  calculateSavings();

  // Redraw on resize
  window.addEventListener('resize', calculateSavings);
</script>
